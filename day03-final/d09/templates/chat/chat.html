<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ room_name }} Chat</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .chat-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      #messages-container {
        height: 400px;
        overflow-y: auto;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 20px;
      }
      .message {
        background-color: #e8f4fd;
        border-left: 3px solid #2196f3;
      }
      .join_message {
        background-color: #f0f0f0;
        border-left: 3px solid green;
      }
      .leave_message {
        background-color: #f0f0f0;
        border-left: 3px solid red;
      }
      #message-form {
        margin-top: 20px;
      }
      #message-form textarea {
        width: 100%;
        height: 60px;
        resize: vertical;
        margin-bottom: 10px;
      }
      #send-message-button {
        background-color: #2196f3;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      #send-message-button:hover {
        background-color: #1976d2;
      }
      .users-sidebar {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        height: fit-content;
      }
      .users-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .users-list li {
        padding: 8px;
        margin: 5px 0;
        background-color: white;
        border-left: 3px solid pink;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <h1 class="mb-4">{{ room_name }} chat</h1>

      <div class="row">
        <div class="col-md-9">
          <div id="messages-container">
            <div id="messages-list"></div>
          </div>

          <form method="" id="message-form">
            {% csrf_token %} {{ form.as_p }}
            <button type="submit" id="send-message-button">Send Message</button>
          </form>
        </div>

        <div class="col-md-3">
          <div class="users-sidebar">
            <h5 class="mb-3">Connected Users</h5>
            <div id="users-count" class="mb-2 text-muted">
              <small>0 users online</small>
            </div>
            <ul id="connected-users-list" class="users-list"></ul>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const messages = [];
    let connectedUsers = [];

    function displayMessage(data) {
      const messagesList = $("#messages-list");
      const messageElement = $("<div>").addClass(data.type).css({
        "margin-bottom": "10px",
        padding: "8px",
        "border-radius": "5px",
        "background-color": "#f0f0f0",
      });
      const messageSender =
        data.type === "join_message" || data.type === "leave_message"
          ? ""
          : `${data.user}:`;

      const userElement = $("<strong>").text(messageSender);
      const messageContent = $("<span>").text(data.message);

      messageElement.append(userElement).append(messageContent);
      messagesList.append(messageElement);
    }

    function updateConnectedUsers(data) {
      if (
        data.type === "join_message" &&
        !connectedUsers.includes(data.username)
      ) {
        connectedUsers.push(data.username);
      } else if (data.type === "leave_message") {
        connectedUsers = [
          ...connectedUsers.filter((user) => user !== data.username),
        ];
      }
      renderConnectedUsers();
    }

    function renderConnectedUsers() {
      const usersList = $("#connected-users-list");
      const usersCount = $("#users-count");

      usersList.empty();

      usersCount
        .find("small")
        .text(
          `${connectedUsers.length} user${
            connectedUsers.length !== 1 ? "s" : ""
          } online`
        );

      if (connectedUsers.length === 0) {
        usersList.append($("<li>").text("No users online"));
      } else {
        connectedUsers.forEach(function (username) {
          const userItem = $("<li>").text(username);
          usersList.append(userItem);
        });
      }
    }

    function displayAllMessages() {
      const messagesList = $("#messages-list");
      messagesList.empty();

      messages.forEach(function (data) {
        displayMessage(data);
      });

      const container = $("#messages-container");
      container.scrollTop(container[0].scrollHeight);
    }

    $(document).ready(function () {
      displayAllMessages();

      const roomName = "{{ room_name }}";
      const chatSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
      );

      chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        updateConnectedUsers(data);

        if (data.type === "messages_history") {
          messages.push(...data.messages);
        } else {
          messages.push(data);
        }

        displayAllMessages();
      };

      chatSocket.onclose = function (e) {
        console.error("Chat socket closed unexpectedly");
      };
      $("#send-message-button").click(function (e) {
        e.preventDefault();
        const form = $("#message-form");
        const textAreaInput = form.find("textarea[name='content']");
        const message = textAreaInput.val();

        if (message.length == 0) {
          return;
        }
        chatSocket.send(
          JSON.stringify({
            message: message,
          })
        );
        textAreaInput.val("");
      });
    });
  </script>
</html>
